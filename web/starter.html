<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="/eel.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"
        integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <title>Home Simulator | Sign In</title>
</head>

<body>
    <!-- component -->
    <section class="bg-white flex flex-col md:flex-row  items-center">

        <div class="m-auto mt-12 md:mt-32 lg:mt-38 md:w-1/2 xl:w-1/3 px-6 lg:px-16 xl:px-12
          items-center">

            <h1 class="lg:mb-4 text-lg md:text-2xl lg:text-3xl font-bold leading-tight text-center">
                Account Login
            </h1>

            <div class="">
                <div>
                    <label class="block text-new_orange-brighter">Email Address</label>
                    <input id="email" type="email" name="email" placeholder="Enter Email Address"
                        class="w-full px-4 py-3 rounded-lg mt-2 border focus:outline-none" autofocus autocomplete
                        required>
                </div>
                <div class="mt-4">
                    <label class="block text-new_orange-brighter">Password</label>
                    <input id="password" type="password" name="password" placeholder="Enter Password" minlength="6"
                        class="w-full px-4 py-3 rounded-lg mt-2 border focus:outline-none" required>
                </div>

                <!-- <div class="text-right mt-2">
                    <button id="forgotPassword"
                        class="text-sm font-semibold text-new_brown-brighter hover:text-new_orange-brighter">Forgot
                        Password?</button>
                </div> -->

                <button id="SignIn" type="submit" class="border w-full block font-semibold rounded-lg
                px-4 py-3 mt-6">Log In</button>
            </div>

            <hr class="my-6 border-new_brown-brighter w-full">

            <button type="button"
                class="w-full block bg-white hover:bg-gray-100 focus:bg-gray-100 text-gray-900 font-semibold rounded-lg px-4 py-3 border border-gray-300">
                <div class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="w-6 h-6"
                        viewBox="0 0 48 48">
                        <defs>
                            <path id="a"
                                d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z" />
                        </defs>
                        <clipPath id="b">
                            <use xlink:href="#a" overflow="visible" />
                        </clipPath>
                        <path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z" />
                        <path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z" />
                        <path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z" />
                        <path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z" />
                    </svg>
                    <span class="ml-4">
                        Log in
                        with
                        Google</span>
                </div>
            </button>

        </div>

    </section>

    <script>
        $(document).ready(function () {
            // check local storage and if user data found sign in and change page
            // console.log(window.location.href);

            var lastPage = document.referrer;
            console.log(lastPage);
            if (lastPage == "") {
                (async function checkLocalStorage() { // fetch dashboard data
                    let email = window.localStorage.getItem('email');
                    let password = window.localStorage.getItem('password');

                    if (email != null && password != null) {
                        let user_data = await eel.signInUser(email, password, true)();
                        let user_type = window.localStorage.getItem('user-type');
                        if (user_data == 'success') {
                            if (user_type == 'Consumer' || user_type == 'Producer') {
                                window.location.href = '/html/dashboard.html';
                            } else {
                                alert('Access forbidden!');
                            }
                        }
                    }
                })();
            }
        });


        // store email and password in local storeage 
        function storeLocalData(email, password, user_id, private_key, user_type, aggregator_public_key, aggregator_id, access_token, chaos_shared_list, username, utility_public_key) {
            window.localStorage.setItem('email', email);
            window.localStorage.setItem('password', password);
            window.localStorage.setItem('user_id', user_id);
            window.localStorage.setItem('private-key', private_key);
            window.localStorage.setItem('user-type', user_type);
            window.localStorage.setItem('aggregator-public-key', aggregator_public_key);
            window.localStorage.setItem('aggregator-id', aggregator_id);
            window.localStorage.setItem('access-token', access_token);
            window.localStorage.setItem('chaos-shared-list', chaos_shared_list);
            window.localStorage.setItem('utility-public-key', utility_public_key);
            window.localStorage.setItem('ascalate-option', false);
        }


        // On Sign in button click trigger this function
        document.getElementById('SignIn').onclick = async function () {
            var email = document.getElementById('email').value;
            var password = document.getElementById('password').value;

            let user_data = await eel.signInUser(email, password, false)();
            console.log(user_data[0]);

            if (user_data[0] != null && (user_data[3] == 'Consumer' || user_data[3] == 'Producer')) {

                // call store user data function
                storeLocalData(email, password, user_data[0], user_data[2], user_data[3], user_data[4], user_data[5], user_data[6], user_data[7], user_data[8], user_data[9]);
                window.location.href = '/html/dashboard.html';
            }
            else {
                alert('Access forbidden!');
                // if unknown error show pop up that some error has occured
            }
        }


    </script>

</body>

</html>